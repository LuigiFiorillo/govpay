<?xml version="1.0" encoding="UTF-8"?>
<b:beans xmlns="http://www.springframework.org/schema/security"
        xmlns:b="http://www.springframework.org/schema/beans"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/security
        http://www.springframework.org/schema/security/spring-security.xsd">
        
        <global-method-security
                secured-annotations="enabled">
        </global-method-security>
        
         <b:bean id="allowUrlEncodedSlashFirewall" class="org.springframework.security.web.firewall.StrictHttpFirewall" >
    		<b:property name="allowUrlEncodedSlash" value="true"/>
    		<b:property name="allowUrlEncodedPercent" value="true"/>
        </b:bean>
        
        <http-firewall ref="allowUrlEncodedSlashFirewall"/>
        
		<!-- CONTAINER START -->
        
        <b:bean id="basicAuthenticationEntryPoint" class="it.govpay.rs.v1.authentication.entrypoint.BasicAuthenticationEntryPoint" >
    		<b:property name="wwwAuthenticate" value="false"/>
        </b:bean>
        
        <b:bean id="userDetailServiceUtenze" class="it.govpay.core.dao.autorizzazione.AutenticazioneUtenzeRegistrateDAO" >
        </b:bean>
        
        <b:bean id="wildflyApplicationAuthenticationProvider" class="org.openspcoop2.utils.jaxrs.impl.authentication.provider.WildflyApplicationAuthenticationProvider" >
			<b:property name="userDetailsService" ref="userDetailServiceUtenze"/>
		</b:bean>
        
        <authentication-manager id="authenticationManager">
                <authentication-provider ref="wildflyApplicationAuthenticationProvider">
                </authentication-provider>
        </authentication-manager>
        
        <b:bean id="formAuthenticationEntryPoint" class="it.govpay.rs.v1.authentication.entrypoint.FormAuthenticationEntryPoint" >
        </b:bean>
        
        <b:bean id="logoutSuccessHandler" class="org.openspcoop2.utils.jaxrs.impl.authentication.handler.DefaultLogoutSuccessHandler" />
        
        <b:bean id="invalidSessionStrategy" class="it.govpay.rs.v1.authentication.session.NotAuthorizedInvalidSessionStrategy">
        	<b:property name="createNewSession" value="false" />
        </b:bean>
        
        <b:bean id="expiredSessionStrategy" class="it.govpay.rs.v1.authentication.session.NotAuthorizedSessionInformationExpiredStrategy">
        </b:bean>
        
        <http auto-config="false" use-expressions="true" create-session="stateless" authentication-manager-ref="authenticationManager" pattern="/rs/basic/**">

                <csrf disabled="true"/>

				<intercept-url pattern="/rs/basic/v1/info" access="permitAll" />
                <intercept-url pattern="/rs/basic/**" access="isFullyAuthenticated()" />
                
                <intercept-url pattern="/**" access="denyAll" />
                
                <http-basic entry-point-ref="basicAuthenticationEntryPoint" />

                <headers>
                        <content-type-options disabled="true"/>
                        <frame-options disabled="true"/>
                        <xss-protection disabled="true"/>
                </headers>
        </http>
        
        <http auto-config="false" pattern="/rs/form/v1/info" security="none"/>
        
        <http auto-config="false" use-expressions="true" create-session="ifRequired" authentication-manager-ref="authenticationManager" pattern="/rs/form/**">

                <csrf disabled="true"/>

				            
                <intercept-url pattern="/rs/form/**" access="isFullyAuthenticated()" />
                
                <intercept-url pattern="/**" access="denyAll" />
                
                <http-basic entry-point-ref="basicAuthenticationEntryPoint" />
                
                <logout logout-url="/rs/form/v1/logout" success-handler-ref="logoutSuccessHandler" delete-cookies="JSESSIONID" invalidate-session="true" />
                
                <session-management session-fixation-protection="changeSessionId" invalid-session-strategy-ref="invalidSessionStrategy">
                	<concurrency-control max-sessions="2" expired-session-strategy-ref="expiredSessionStrategy" />
	       		</session-management>

                <headers>
                        <content-type-options disabled="true"/>
                        <frame-options disabled="true"/>
                        <xss-protection disabled="true"/>
                </headers>
        </http>
        
        <!-- CONTAINER END -->
        
        <!-- SSL START -->
        
        <b:bean id="x509AuthenticationEntryPoint" class="it.govpay.rs.v1.authentication.entrypoint.X509AuthenticationEntryPoint" />
        
        <b:bean id="userDetailServiceUtenzeSSL" class="it.govpay.core.dao.autorizzazione.AutenticazioneUtenzeRegistrateDAO" >
        	<b:property name="checkSubject" value="true"/>
        </b:bean>
        
        <http auto-config="false" use-expressions="true" create-session="stateless" entry-point-ref="x509AuthenticationEntryPoint" pattern="/rs/ssl/**">

                <csrf disabled="true"/>

				<intercept-url pattern="/rs/ssl/v1/info" access="permitAll" />
                <intercept-url pattern="/rs/ssl/**" access="isFullyAuthenticated()" />
                
                <intercept-url pattern="/**" access="denyAll" />
                <x509 subject-principal-regex="^(.*)$"  user-service-ref="userDetailServiceUtenzeSSL" />

                <headers>
                        <content-type-options disabled="true"/>
                        <frame-options disabled="true"/>
                        <xss-protection disabled="true"/>
                </headers>
        </http>
        
       <!-- SSL END -->
       
        <b:bean id="http403ForbiddenEntryPointGenerale" class="it.govpay.rs.v1.authentication.entrypoint.Http403ForbiddenEntryPoint" >
        </b:bean>
        
        <http auto-config="false" use-expressions="true" create-session="stateless" entry-point-ref="http403ForbiddenEntryPointGenerale" pattern="/**"> 

                <csrf disabled="true"/>

                <intercept-url pattern="/govpay-api-backoffice.yaml" access="permitAll"/>
                <intercept-url pattern="/index.html" access="permitAll"/>
                <intercept-url pattern="/*.png" access="permitAll"/>
                <intercept-url pattern="/*.css" access="permitAll"/>
                <intercept-url pattern="/*.css.map" access="permitAll"/>
                <intercept-url pattern="/*.js" access="permitAll"/>
                <intercept-url pattern="/*.js.map" access="permitAll"/>
                
                <intercept-url pattern="/**" access="permitAll" method="OPTIONS"/>
                
                <intercept-url pattern="/**" access="denyAll" />

                <headers>
                        <content-type-options disabled="true"/>
                        <frame-options disabled="true"/>
                        <xss-protection disabled="true"/>
                </headers>
        </http>
</b:beans>
        