put_pendenza:
  tags:
    - Pendenze
  summary: Creazione o aggiornamento di una pendenza
  description: >-
    Per ciascuna pendenza viene richiesto un identificativo (_idPendenza_)
    valido per il gestionale che ne effettua il caricamento (_idA2A_).
    L'operazione è idempotente rispetto a questo identificativo e nel caso
    venga eseguito il caricamento di una pendenza con un identificativo già
    presente nell'archivio di GovPay, questa sarà gestita come un
    aggiornamento. <br/> Ciascuna pendenza può
    essere composta da più voci fino ad un massimo di cinque, ciascuna
    avente un identificativo _idVocePendenza_ assegnato dal gestionale come
    riferimento interno. 
  parameters:
    - in: path
      name: idA2A
      description: Identificativo del gestionale
      required: true
      schema:
        type: string
    - in: path
      name: idPendenza
      description: Identificativo della pendenza
      required: true
      schema:
        type: string
  requestBody:
    content:
      application/json:
        schema:
          $ref: '#/pendenzaPut'
  responses:
    '200':
      description: Pendenza aggiornata con successo
      content:
        application/json:
          schema:
            $ref: './avvisi.yaml#/avviso'
    '201':
      description: Pendenza creata con successo
      content:
        application/json:
          schema:
            $ref: '#/avviso'
    '400':
      $ref: './errori.yaml#/responses/400'
    '401':
      $ref: './errori.yaml#/responses/401'
    '403':
      $ref: './errori.yaml#/responses/403'
    '500':
      $ref: './errori.yaml#/responses/500'
patch_pendenza:
  description: >-
    L'aggiornamento dello stato di una pendenza in `Annullata` può essere completato solo se la pendenza si trova in stato `Da pagare`. Viceversa il ripristino dello stato `Da pagare` può essere disposto solo in caso di pendenza `Annullata`.
    L'aggiornamento è consentito solo se di dispone di ACL per il servizio Pendenze di tipo scrittura. 
  tags:
    - Pendenze
  summary: Annullamento o ripristino di una pendenza
  parameters:
    - in: path
      name: idA2A
      description: Identificativo del gestionale
      required: true
      schema:
        type: string
    - in: path
      name: idPendenza
      description: Identificativo della pendenza
      required: true
      schema:
        type: string
  requestBody:
    content:
      application/json:
        schema:
          type: object
          required:
          - stato
          properties:
            stato:
              $ref: '#/statoPendenza'
            descrizioneStato:
              description: Causale del cambio di stato.
              example: Annullata
              type: string
  responses:
    '200':
      description: Pendenza aggiornata con successo
    '400':
      $ref: './errori.yaml#/responses/400'
    '401':
      $ref: './errori.yaml#/responses/401'
    '403':
      $ref: './errori.yaml#/responses/403'
    '404':
      $ref: './errori.yaml#/responses/404'      
    '500':
      $ref: './errori.yaml#/responses/500'
get_pendenze:
  tags:
    - Pendenze
  summary: Elenco delle pendenze
  description: Fornisce la lista delle pendenze filtrata ed ordinata.
  parameters:
    - $ref: './comuni.yaml#/pagina'
    - $ref: './comuni.yaml#/risultatiPerPagina'
    - $ref: './comuni.yaml#/campi'      
    - name: ordinamento
      in: query
      description: >-
        csv dei campi su cui ordinare i risultati, preceduti da + o - per ascendente o discendente (default ascendente)
         * dataCaricamento
         * dataScadenza
         * dataValidita
         * stato
      required: false
      schema:
        type: string
        format: csv
        default: +dataRichiestaPagamento
    - name: idDominio
      in: query
      description: filtro per dominio creditore
      required: false
      schema:
        type: string
    - name: idA2A
      in: query
      description: filtro per gestionale
      required: false
      schema:
        type: string
    - name: idDebitore
      in: query
      description: filtro per codice fiscale o p. iva del soggetoto debitore
      required: false
      schema:
        type: string
    - name: stato
      in: query
      description: filtro sullo stato della pendenza
      required: false
      schema:
        $ref: '#/statoPendenza'
    - in: query
      name: idPagamento
      description: Identificativo del pagamento
      required: false
      schema:
        type: string
  responses:
    '200':
      description: Elenco delle pendenze che rispettano i filtri di ricerca
      content:
        application/json:
          schema:
            allOf:
              - $ref: './comuni.yaml#/listaPaginata'
              - type: object
                required:
                  - risultati
                properties:
                  risultati:
                    type: array
                    items:
                      $ref: '#/pendenzaIndex'
    '401':
      $ref: './errori.yaml#/responses/401'
    '403':
      $ref: './errori.yaml#/responses/403'
    '500':
      $ref: './errori.yaml#/responses/500'
get_pendenza:
  tags:
    - Pendenze
  summary: Dettaglio di una pendenza per identificativo
  description: Acquisisce il dettaglio di una pendenza, comprensivo dei dati di pagamento.
  parameters:
    - in: path
      name: idA2A
      description: Identificativo del gestionale
      required: true
      schema:
        type: string
    - in: path
      name: idPendenza
      description: Identificativo della pendenza
      required: true
      schema:
        type: string
  responses:
    '200':
      description: Informazioni dettagliate della pendenza
      content:
        application/json:
          schema:
            $ref: '#/pendenza'
    '401':
      $ref: './errori.yaml#/responses/401'
    '403':
      $ref: './errori.yaml#/responses/403'
    '404':
      $ref: './errori.yaml#/responses/404'
    '500':
      $ref: './errori.yaml#/responses/500'
pendenzaBase:
  type: object
  required:
    - idDominio
    - soggettoPagatore
    - importo
    - causale
  properties:
    nome:
      type: string
      description: Nome della pendenza da visualizzare sui portali di pagamento e console di gestione.
      example: 'Immatricolazione AA 2017/2018'
    causale:
      type: string
      description: Descrizione da inserire nell'avviso di pagamento
      example: 'Sanzione CdS n. abc00000'
    soggettoPagatore:
      $ref: './comuni.yaml#/soggetto'
    importo:
      type: number
      description: Importo della pendenza. Deve corrispondere alla somma delle singole voci.
      example: 10.01
    numeroAvviso:
      type: string
      description: Identificativo univoco versamento, assegnato se pagabile da psp
      example: 123456789012345678
    dataCaricamento:
      type: string
      format: date
      description: Data di emissione della pendenza
      example: '2010-12-31'
    dataValidita:
      type: string
      format: date
      description: Data di validita dei dati della pendenza, decorsa la quale la pendenza può subire variazioni.
      example: '2019-12-31'
    dataScadenza:
      type: string
      format: date
      description: Data di scadenza della pendenza, decorsa la quale non è più pagabile.
      example: '2020-12-31'
    annoRiferimento:
      type: number
      description: Anno di riferimento della pendenza
      example: 2020
    cartellaPagamento:
      type: string
      description: Identificativo della cartella di pagamento a cui afferisce la pendenza
      example: ABC00000001
    datiAllegati:
      type: string
      description: Dati applicativi allegati dal gestionale secondo un formato proprietario.          
    tassonomia:
      type: string
      description: Macro categoria della pendenza secondo la classificazione del creditore
      example: Sanzioni
    tassonomiaAvviso:
      $ref: './avvisi.yaml#/tassonomiaAvviso'
pendenzaPut:
  type: object
  allOf:
    - type: object
      required:
        - idDominio
      properties:
        idDominio:
          type: string
          description: Identificativo del dominio creditore
          example: 1234567890
        idUnitaOperativa:
          type: string
          description: Identificativo dell'unita' operativa
          example: UO33132
    - $ref: '#/pendenzaBase'    
    - type: object
      required:
        - voci
      properties:   
        voci:
          type: array
          minItems: 1
          maxItems: 5
          items:
            $ref: '#/vocePendenza'
pendenzaPost:
  allOf:
    - type: object
      required:
        - idA2A
        - idPendenza
      properties:
        idA2A:
          type: string
          description: Identificativo del gestionale responsabile della pendenza
          example: A2A_12345
        idPendenza:
          type: string
          description: Identificativo della pendenza nel gestionale responsabile
          example: abcdef12345
    - $ref: '#/pendenzaPut'        
pendenzaIndex:
  type: object
  allOf:
    - type: object
      required:
        - idA2A
        - idPendenza
        - dominio
        - stato
        - dataCaricamento        
      properties:
        idA2A:
          type: string
          description: Identificativo del gestionale responsabile della pendenza
          example: A2A-12345
        idPendenza:
          type: string
          description: Identificativo della pendenza nel gestionale responsabile
          example: abcdef12345
        dominio:
          $ref: './domini.yaml#/dominioIndex'
        unitaOperativa:
          $ref: './domini.yaml#/unitaOperativa'
        stato:
          $ref: '#/statoPendenza'
        segnalazioni:
          type: array
          items: 
            $ref: './comuni.yaml#/segnalazione'          
    - $ref: '#/pendenzaBase'   
    - type: object
      required:
        - rpp
        - pagamenti
      properties:
        rpp:
          type: string
          description: Url per l'elenco delle rpp emesse per la pendenza
          example: '/rpp?idPendenza=idA2A=A2A-12345&abcdef12345'
        pagamenti:
          type: string
          description: Url per l'elenco dei pagamenti da portale comprensivi della pendenza
          example: '/pagamenti?idA2A=A2A-12345&idPendenza=abcdef12345'  
pendenza:
  type: object
  allOf:
    - type: object
      required:
        - idA2A
        - idPendenza
        - dominio
        - stato
        - dataCaricamento        
      properties:
        idA2A:
          type: string
          description: Identificativo del gestionale responsabile della pendenza
          example: A2A-12345
        idPendenza:
          type: string
          description: Identificativo della pendenza nel gestionale responsabile
          example: abcdef12345
        dominio:
          $ref: './domini.yaml#/dominioIndex'
        unitaOperativa:
          $ref: './domini.yaml#/unitaOperativa'
        stato:
          $ref: '#/statoPendenza'
        segnalazioni:
          type: array
          items: 
            $ref: './comuni.yaml#/segnalazione'          
    - $ref: '#/pendenzaBase'   
    - type: object
      required:
        - voci
        - rpp
        - pagamenti
      properties:
        voci:
          type: array
          minItems: 1
          maxItems: 5
          items:
            $ref: '#/vocePendenza'
        rpp:
          type: array
          items:
            $ref: './rpp.yaml#/rpp'
        pagamenti:
          type: array
          items:
            $ref: './pagamenti.yaml#/pagamento'      
vocePendenza:
  allOf:
    - type: object
      required:
        - idVocePendenza
        - importo
        - descrizione
      properties:
        indice:
          type: number
          description: indice di voce all'interno della pendenza
          example: 1
        idVocePendenza:
          type: string
          description: Identificativo della voce di pedenza nel gestionale proprietario
          example: abcdef12345_1
        importo:
          type: number
          description: Importo della voce
          example: 10.01
        descrizione:
          type: string
          description: descrizione della voce di pagamento
          example: Sanzione CdS n. abc00000
        datiAllegati:
          type: string
          description: Dati applicativi allegati dal gestionale secondo un formato proprietario.
    - oneOf:
        - description: Definisce i dettagli di incasso tramite riferimento in anagrafica GovPay.
          type: object
          required:
            - codEntrata
          properties:
            codEntrata:
              type: string
        - description: Definisce i dettagli di incasso.
          type: object
          required:
            - ibanAccredito
            - tipoContabilita
            - codiceContabilita
          properties:
            ibanAccredito:
              type: string
              example: IT60X0542811101000000123456
            ibanAppoggio:
              type: string
              example: IT60X0542811101000000123456
            tipoContabilita:
              description: Tipologia di codifica del capitolo di bilancio
              type: string
              enum:
                - Entrata
                - Speciale
                - SIOPE
                - Altro
              example: SIOPE
            codiceContabilita:
              description: Codifica del capitolo di bilancio
              type: string
              example: 3321
        - description: Definisce i dati di un bollo telematico
          type: object
          required:
            - tipoBollo
            - hashDocumento
            - provinciaResidenza
          properties:
            tipoBollo:
              description: Tipologia di Bollo digitale
              type: string
              enum:
                - Imposta di bollo
            hashDocumento:
              description: Digest in base64 del documento informatico associato alla marca da bollo
              type: string
            provinciaResidenza:
              description: Sigla automobilistica della provincia di residenza del soggetto pagatore
              type: string
avviso:
  type: object
  required:
    - stato
  properties:
    stato:
      description: Stato dell'avviso
      example: Non pagato
      type: string
      enum:
        - Pagato
        - Non pagato
        - Scaduto
        - Annullato
    importo:
      type: number
      description: Importo della pendenza associata all'avviso.
      example: 10.01
    idDominio:
      type: string
      description: Identificativo del creditore dell'avviso
      example: 01234567890
    numeroAvviso:
      type: string
      description: Numero identificativo dell'avviso di pagamento
      example: 00100000000000012
    dataValidita:
      type: string
      format: date
      description: Data di validita dei dati dell'avviso, decorsa la quale l'importo può subire variazioni.
      example: '2019-12-31'
    dataScadenza:
      type: string
      format: date
      description: Data di scadenza dell'avviso, decorsa la quale non è più pagabile.
      example: '2020-12-31'
    descrizione:
      type: string
      description: Descrizione da inserire nell'avviso di pagamento
      example: 'Sanzione CdS n. abc00000'
    tassonomiaAvviso:
      type: string
      description: Macro categoria della pendenza secondo la classificazione AgID
      example: Sanzioni
    qrcode:
      type: string
      description: Testo da codificare nel qr-code dell'avviso
    barcode:
      type: string
      description: Testo da codificare nel bar-code dell'avviso                 
statoPendenza:
  example: NON_ESEGUITO
  type: string
  enum:
    - ESEGUITA
    - NON_ESEGUITA
    - ESEGUITA_PARZIALE
    - ANNULLATA
    - SCADUTA
  description: >-
    Stato della pendenza: 
     * ESEGUITA: Pagata
     * NON_ESEGUITA: Da pagare
     * ESEGUITA_PARZIALE: Pagata parzialmente
     * ANNULLATA: Annullata
     * SCADUTA: Scaduta    