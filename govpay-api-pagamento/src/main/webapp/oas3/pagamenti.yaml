post_pagamento:
  summary: Avvio di un pagamento di pendenze
  description: >-
    L'operazione consente di avviare una sessione di pagamento per una o più
    pendenze. Le pendenze presenti in posizione debitoria possono essere
    riferite tramite identificativo della pendenza del gestionale proprietario 
    (_idA2A_ e _idPendenza_) oppure con l'identificativo avviso (_idDominio_ 
    e _iuv_). Nel caso invece di pendenze note al portale, è possibile
    fornire direttamente i dati della pendenza.
  parameters:
    - in: query
      name: idSessionePortale
      description: Identificativo della sessione di pagamento nel portale.
      required: false
      schema:
        type: string
  requestBody:
    content:
      application/json:
        schema:
          $ref: '#/pagamentoPost'
  responses:
    '201':
      description: Pagamento creato
      content:
        application/json:
          schema:
            type: object
            required:
              - id
              - location
              - redirect
            properties:
              id:
                type: string
                description: identificativo del pagamento
                example: 12345
              location:
                type: string
                description: Url del dettaglio del pagamento
                example: /pagamenti/12345
              redirect:
                type: string
                description: url a cui redirigere il navigatore per proseguire nel pagamento.
                example: >-
                  https://www.comune.it/pagopa/pap/bdd07392-d90d-11e7-9296-cec278b6b50a
              idSession:
                type: string
                description: identificativo della sessione di pagamento per la riconciliazione in al ritorno dal psp.
                example: bdd07392-d90d-11e7-9296-cec278b6b50a
    '400':
      $ref: './errori.yaml#/responses/400'
    '401':
      $ref: './errori.yaml#/responses/401'
    '403':
      $ref: './errori.yaml#/responses/403'
    '500':
      $ref: './errori.yaml#/responses/500'
    '502':
      $ref: './errori.yaml#/responses/502'
get_pagamenti:
  summary: Lista dei pagamenti
  parameters:
    - $ref: './comuni.yaml#/pagina'
    - $ref: './comuni.yaml#/risultatiPerPagina'
    - $ref: './comuni.yaml#/campi'
    - name: ordinamento
      in: query
      description: >-
        csv dei campi su cui ordinare i risultati, preceduti da + o - per ascendente o discendente (default ascendente)
         * dataRichiestaPagamento
         * stato
      required: false
      schema:
        type: string
        format: csv
        default: +dataRichiestaPagamento
    - in: query
      name: stato
      description: Filtro sullo stato del pagamento
      required: false
      schema:
        $ref: 'pagamenti.yaml#/statoPagamento'
    - in: query
      name: versante
      description: Filtro sul codice fiscale del versante
      required: false
      schema:
        type: string
        example: 'RSSMRA30A01H501I'
    - in: query
      name: idSessionePortale
      description: Filtro sull'identificativo di sessione assegnato dal chiamante
      required: false
      schema:
        type: string
        example: 'c8be909b-2feb-4ffa-8f98-704462abbd1d'
  responses:
    '200':
      description: Elenco dei pagamenti da portale
      content:
        application/json:
          schema:
            allOf:
              - $ref: './comuni.yaml#/listaPaginata'
              - type: object
                required:
                  - risultati
                properties:
                  risultati:
                    type: array
                    items:
                      $ref: '#/pagamentoIndex'
    '400':
      $ref: './errori.yaml#/responses/400'
    '401':
      $ref: './errori.yaml#/responses/401'
    '403':
      $ref: './errori.yaml#/responses/403'
    '500':
      $ref: './errori.yaml#/responses/500'
    '502':
      $ref: './errori.yaml#/responses/502'
get_pagamento:      
  summary: Dettaglio di un pagamento
  parameters:
    - in: path
      name: id
      description: Identificativo del pagamento
      required: true
      schema:
        type: string
  responses:
    '200':
      description: Dettaglio del pagamento
      content:
        application/json:
          schema:
            $ref: '#/pagamento'
    '401':
      $ref: './errori.yaml#/responses/401'
    '403':
      $ref: './errori.yaml#/responses/403'
    '404':
      $ref: './errori.yaml#/responses/404'
    '500':
      $ref: './errori.yaml#/responses/500'      
pagamentoPost: 
  type: object
  required:
    - pendenze
  properties:
    pendenze:
      type: array
      description: pendenze o riferimenti alle pendenze oggetto del pagamento
      items:
        anyOf:
          - type: object
            required:
              - idA2A
              - idPendenza
            properties:
              idA2A:
                type: string
                description: >-
                  Identificativo del gestionale responsabile della
                  pendenza
                example: A2A_12345
              idPendenza:
                type: string
                description: >-
                  Identificativo della pendenza nel gestionale
                  responsabile
                example: abcdef12345
          - type: object
            required:
              - idDominio
              - iuv
            properties:
              idDominio:
                type: string
                description: Codice fiscale dell'ente creditore
                example: 01234567890
              numeroAvviso:
                type: string
                description: >-
                  Numero avviso della pendenza, assegnato se
                  pagabile da psp
                example: 123456789012345678
          - $ref: './pendenze.yaml#/pendenzaPost'
    urlRitorno:
      type: string
      description: >-
        url di ritorno al portale al termine della sessione di pagamento
      example: >-
        https://www.comune.it/pagamentopagopa/abcd-efgh-ijklm-12345
    contoAddebito:
      type: object
      description: >-
        Dati necessari alla realizzazione dei pagamenti per Addebito
        Diretto, se previsto dal profilo del versante.
      required:
        - ibanAddebito
      properties:
        ibanAddebito:
          type: string
          description: Iban di addebito del pagatore.
          example: IT02L1234512345123456789012
        bicAddebito:
          type: string
          description: Bic della banca di addebito del pagatore.
          example: MYBICODE
    dataEsecuzionePagamento:
      type: string
      format: date
      example: '2018-12-31'
      description: >-
        data in cui si richiede che venga effettuato il pagamento, se diversa dalla data corrente.
    credenzialiPagatore:
      type: string
      description: >-
        Eventuali credenziali richieste dal PSP necessarie per
        completare l'operazione (ad esempio un codice bilaterale
        utilizzabile una sola volta).
    soggettoVersante:
      $ref: './comuni.yaml#/soggetto'
    autenticazioneSoggetto:
      type: string
      enum:
        - CNS
        - USR
        - OTH
        - N/A
      description: modalita' di autenticazione del soggetto versante
    lingua:
      type: string
      description: Indica il codice della lingua da utilizzare per l’esposizione delle pagine web.
      enum:
        - IT
        - EN
        - FR
        - DE
        - SL
      default: IT
      example: IT  
pagamentoIndex:
  type: object
  required:
    - id
    - dataRichiestaPagamento
    - stato
  properties:
    id:
      type: string
      example: 'f9866575-e255-4d10-9845-57ba88bec136'
      description: Identificativo del pagamento assegnato da GovPay
    idSessionePortale:
      type: string
      example: 'c8be909b-2feb-4ffa-8f98-704462abbd1d'
      description: Identificativo del pagamento assegnato dal portale chiamante
    idSessionePsp:
      type: string
      example: '7f905970-cfe9-4ee5-a9a7-81fe14e7437e'
      description: Identificativo del pagamento assegnato dal psp utilizzato
    importo:
      type: number
      description: >-
        Importo del pagamento. Corrisponde alla somma degli importi delle pendenze al momento della richiesta
    stato:
      $ref: '#/components/schemas/statoPagamento'
    pspRedirectUrl:
      type: string
      example: 'https://www.psp.it/payment?sessionId=7f905970-cfe9-4ee5-a9a7-81fe14e7437e'
      description: Url di redirect al psp inviata al versante per perfezionare il pagamento, se previsto dal modello
    urlRitorno:
      type: string
      description: >-
        url di ritorno al portale al termine della sessione di pagamento
      example: >-
        https://www.comune.it/pagamentopagopa/abcd-efgh-ijklm-12345
    contoAddebito:
      type: object
      description: >-
        Dati necessari alla realizzazione dei pagamenti per Addebito
        Diretto, se previsto dal profilo del versante.
      required:
        - ibanAddebito
      properties:
        ibanAddebito:
          type: string
          description: Iban di addebito del pagatore.
          example: IT02L1234512345123456789012
        bicAddebito:
          type: string
          description: Bic della banca di addebito del pagatore.
          example: MYBICODE
    dataEsecuzionePagamento:
      type: string
      format: date
      example: '2018-12-31'
      description: >-
        data in cui si richiede che venga effettuato il pagamento, se diversa dalla data corrente.
    credenzialiPagatore:
      type: string
      description: >-
        Eventuali credenziali richieste dal PSP necessarie per
        completare l'operazione (ad esempio un codice bilaterale
        utilizzabile una sola volta).
    soggettoVersante:
      $ref: '#/components/schemas/soggetto'
    autenticazioneSoggetto:
      type: string
      enum:
        - CNS
        - USR
        - OTH
        - N/A
      description: modalita' di autenticazione del soggetto versante
    lingua:
      type: string
      description: Indica il codice della lingua da utilizzare per l’esposizione delle pagine web.
      enum:
        - IT
        - EN
        - FR
        - DE
        - SL
      default: IT
      example: IT                
    pendenze:
      type: string
      description: Url per le pendenze oggetto del Pagamento
      example: '/pendenze?idPagamento=f9866575-e255-4d10-9845-57ba88bec136'  
    rpp:
      type: string
      description: Url per le richieste di pagamento oggetto del Pagamento
      example: '/rpp?idPagamento=f9866575-e255-4d10-9845-57ba88bec136'
pagamento:
  type: object
  required:
    - id
    - dataRichiestaPagamento
    - stato
  properties:
    id:
      type: string
      example: 'f9866575-e255-4d10-9845-57ba88bec136'
      description: Identificativo del pagamento assegnato da GovPay
    idSessionePortale:
      type: string
      example: 'c8be909b-2feb-4ffa-8f98-704462abbd1d'
      description: Identificativo del pagamento assegnato dal portale chiamante
    idSessionePsp:
      type: string
      example: '7f905970-cfe9-4ee5-a9a7-81fe14e7437e'
      description: Identificativo del pagamento assegnato dal psp utilizzato
    importo:
      type: number
      description: >-
        Importo del pagamento. Corrisponde alla somma degli importi delle pendenze al momento della richiesta
    stato:
      $ref: '#/statoPagamento'
    pspRedirectUrl:
      type: string
      example: 'https://www.psp.it/payment?sessionId=7f905970-cfe9-4ee5-a9a7-81fe14e7437e'
      description: Url di redirect al psp inviata al versante per perfezionare il pagamento, se previsto dal modello
    urlRitorno:
      type: string
      description: >-
        url di ritorno al portale al termine della sessione di pagamento
      example: >-
        https://www.comune.it/pagamentopagopa/abcd-efgh-ijklm-12345
    contoAddebito:
      type: object
      description: >-
        Dati necessari alla realizzazione dei pagamenti per Addebito
        Diretto, se previsto dal profilo del versante.
      required:
        - ibanAddebito
      properties:
        ibanAddebito:
          type: string
          description: Iban di addebito del pagatore.
          example: IT02L1234512345123456789012
        bicAddebito:
          type: string
          description: Bic della banca di addebito del pagatore.
          example: MYBICODE
    dataEsecuzionePagamento:
      type: string
      format: date
      example: '2018-12-31'
      description: >-
        data in cui si richiede che venga effettuato il pagamento, se diversa dalla data corrente.
    credenzialiPagatore:
      type: string
      description: >-
        Eventuali credenziali richieste dal PSP necessarie per
        completare l'operazione (ad esempio un codice bilaterale
        utilizzabile una sola volta).
    soggettoVersante:
      $ref: './comuni.yaml#/soggetto'
    autenticazioneSoggetto:
      type: string
      enum:
        - CNS
        - USR
        - OTH
        - N/A
      description: modalita' di autenticazione del soggetto versante
    lingua:
      type: string
      description: Indica il codice della lingua da utilizzare per l’esposizione delle pagine web.
      enum:
        - IT
        - EN
        - FR
        - DE
        - SL
      default: IT
      example: IT                
    pendenze:
      type: array
      items: 
        $ref: './pendenze.yaml#/pendenzaIndex'
    rpp:
      type: array
      items: 
        $ref: './rpp.yaml#/rppIndex'
statoPagamento:
  type: string
  example: ESEGUITO
  enum:
    - IN_CORSO
    - ESEGUITO
    - NON_ESEGUITO
    - ESEGUITO_PARZIALE
    - ANNULLATO
    - FALLITO
  description: > 
    Stato del pagamento
     * IN_CORSO: Pagamento in corso
     * ANNULLATO: Pagamento annullato dall'utente o scaduto per timeout
     * FALLITO: Pagamento non perfezionato per errori della piattaforma
     * ESEGUITO: Pagamento concluso con successo
     * NON_ESEGUITO: Processo concluso senza il perfezionamento del pagamento
     * ESEGUITO_PARZIALE: Pagamento parzialmente eseguito        