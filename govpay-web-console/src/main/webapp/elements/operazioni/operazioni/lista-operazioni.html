<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../../bower_components/polymer/polymer.html">

<dom-module id="lista-operazioni">
    <template>
        <style include="shared-styles"></style>
        <style>
            :host {
            display: block;
            }
        </style>
        <iron-ajax auto="false"
                   id="connettoreOperazioni"
                   url="{{govpayUrl}}"
                   params="{{actionParams}}"
                   method="{{actionMethod}}"
                   handle-as="json"
                   content-type="application/json"
                   last-response="{{esitoOperazione}}"
                   last-error="{{ajaxErrorOperazione}}"
                   on-response="_visualizzaEsitoOperazione"
                   on-error="_visualizzaMessaggioErrore">
        </iron-ajax>
        <div class="layout horizontal center-justified restorePadding">
            <div id="resultbox" class="layout vertical flex">
                <div id="listToolbox" class="layout horizontal center end-justified headerbox">
                    <paper-icon-button icon="icons:file-upload" hidden="true"></paper-icon-button>
                    <paper-icon-button icon="icons:remove" hidden="true"></paper-icon-button>
                </div>
                <paper-material elevation="0">
                    <paper-input bind-value="{{filtro}}" class="flex filtro" label="Filtro" hidden>
                    </paper-input>
                    <paper-icon-item hidden="true">
                        <paper-checkbox item-icon></paper-checkbox>
                        <div class="flex selectAll">Seleziona tutto</div>
                    </paper-icon-item>

                    <paper-icon-item class="even" on-tap="_aggiornaElencoPsp">
                        <paper-checkbox item-icon hidden="true"></paper-checkbox>
                       <paper-item-body two-line>
                            <div>Aggiorna PSP</div>
                            <div secondary>Aggiorna l'elenco dei Psp.</div>
                        </paper-item-body>
                    </paper-icon-item>

                    <paper-icon-item class="odd" on-tap="_recuperaRpt">
                        <paper-checkbox item-icon hidden="true"></paper-checkbox>
                        <paper-item-body two-line>
                            <div>Recupera RPT</div>
                            <div secondary>Verifica l'esistenza di Rpt.</div>
                        </paper-item-body>
                    </paper-icon-item>

                    <paper-icon-item class="even" on-tap="_acquisisciRendicontazioni">
                        <paper-checkbox item-icon hidden="true"></paper-checkbox>
                        <paper-item-body two-line>
                            <div>Acquisisci Rendicontazioni</div>
                            <div secondary>Acquisisce i flussi di Rendicontazione.</div>
                        </paper-item-body>
                    </paper-icon-item>
                    <paper-icon-item class="odd" on-tap="_resetCache">
                        <paper-checkbox item-icon hidden="true"></paper-checkbox>
                        <paper-item-body two-line>
                            <div>Cache Reset</div>
                            <div secondary>Reset della Cache.</div>
                        </paper-item-body>
                    </paper-icon-item>
                </paper-material>
            </div>
        </div>
    </template>
    <script>
  (function() {
    'use strict';

    Polymer({
      is: 'lista-operazioni',

      properties: {
        selected: {
          type: Number,
          value: 0
        },
        titoloSezione: {
            type: String,
            value: 'Operazioni'
          },
        govpayUrl: { type: String, value: function (){ return  null ;} },
        govpayBaseUrl: { type: String, value: function (){ return govpayUrl + '/rs/dars/operazioni/'; } },
        operazioneCorrente: {
          type: Object,
          value: ''
        },
        operazioneCorrenteOk: {
          type: Object,
          value: null
        },
        operazioneCorrenteKo: {
          type: Object,
          value: null
        },
        actionParams: {
            type: Object, value: function (){ return  { } }, notify: true
          },
        actionMethod: {
            type: String, value : 'GET'
        }
      },
       init: function() {
          // per ora non faccio nulla
        },
        _aggiornaElencoPsp:  function(event){
            this.operazioneCorrenteOk = 'Aggiornamento dell\'elenco Psp completato con successo.';
            this.operazioneCorrenteKo = 'Aggiornamento dell\'elenco Psp non completato.';
            this.operazioneCorrente = 'aggiornaPsp';
            this.govpayUrl = this.govpayBaseUrl + 'aggiornaPsp';
        },
        _recuperaRpt:  function(event){
            this.operazioneCorrenteOk = 'Recupero RPT pendenti completato con successo.';
            this.operazioneCorrenteKo = 'Recupero RPT pendenti non completato.';
            this.operazioneCorrente = 'recuperoRpt';
            this.govpayUrl = this.govpayBaseUrl + 'recuperoRptPendenti';
        },
        _acquisisciRendicontazioni:  function(event){
            this.operazioneCorrenteOk = 'Acquisizione delle Rendicontazioni completata con successo.';
            this.operazioneCorrenteKo = 'Acquisizione delle Rendicontazioni non completata.';
            this.operazioneCorrente = 'acquisisciRendicontazioni';
            this.govpayUrl = this.govpayBaseUrl + 'acquisizioneRendicontazioni';
        },
        _resetCache:  function(event){
            this.operazioneCorrenteOk = 'Reset della Cache completato con successo.';
            this.operazioneCorrenteKo = 'Reset della Cache non completato.';
            this.operazioneCorrente = 'resetCache';
            this.govpayUrl = this.govpayBaseUrl + 'resetCache';
        },
         _visualizzaEsitoOperazione: function(event){
         var messaggi = document.querySelector('#messaggiUtente');
            if(messaggi){
                if(this.operazioneCorrente != ''){
                    if(this.esitoOperazione){
                        var esitoOperazione = this.esitoOperazione.esitoOperazione;
                        var codOperazione = this.esitoOperazione.codOperazione;
                        var dettaglioEsito = this.esitoOperazione.dettaglioEsito;

                        var messaggio= '';

                        if(esitoOperazione == 'ESEGUITA'){
                                messaggio = this.operazioneCorrenteOk + ' Id Operazione: ' + codOperazione + '.';
                        } else {
                                messaggio = this.operazioneCorrenteKo + ' ' + dettaglioEsito + '.';
                        }

                        messaggi.text = messaggio;
                    }else {
                        messaggi.text = 'Operazione Eseguita';
                    }
                    messaggi.show();

                    this.operazioneCorrenteKo = '';
                    this.operazioneCorrenteOk = '';
                    this.operazioneCorrente = '';
                    this.govpayUrl = '';
                }
            }
      },
      _visualizzaMessaggioErrore: function(event){
         this.fire('dars-error', {error: event.detail});
      }
    });
  })();
  </script>
</dom-module>
